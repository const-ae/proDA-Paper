---
title: "R Notebook"
output: html_notebook
---

```{r}

library(tidyverse)
library(proDA)
library(DEP)
library(DAPAR)
library(SummarizedExperiment)
library(cowplot)
source("run_dep.R")
source("run_dapar.R")
source("run_proDA.R")
source("run_qprot.R")
source("run_perseus.R")
source("run_ebrct.R")
source("RanCenHier2Fun_modified.R")
source("run_msqrob.R")
source("run_msempire.R")
source("run_triqler.R")

```







# Load Data

Load the proteome benchmark data from the Cox et al. 2014 paper.
It contains the data from an LFQ experiment, where two different quantities
of _E. coli_ peptides were spiked into a constant human peptide background.

This way we know that every identified _E. coli_ protein is a True positive and 
every human protein is a False positive.

```{r}
raw_data <- read_tsv("../data/cox_proteome_benchmark/proteinGroups.txt")
tidy_data <- raw_data %>%
    dplyr::select(ProteinID=`Protein IDs`, starts_with("LFQ intensity ")) %>%
    gather(Sample, Intensity, starts_with("LFQ intensity ")) %>%
    mutate(Condition = str_match(Sample, 
                 "LFQ intensity ([HL])\\d+")[,2]) %>%
    mutate(Replicate = as.numeric(str_match(Sample, 
                 "LFQ intensity [HL](\\d+)")[,2])) %>%
    mutate(SampleName = paste0(Condition, Replicate))

tidy_data
```



```{r}
data <- tidy_data %>%
    mutate(Intensity = ifelse(Intensity == 0, NA, log2(Intensity))) %>%
    dplyr::select(ProteinID, SampleName, Intensity) %>%
    spread(SampleName, Intensity) %>%
    column_to_rownames("ProteinID") %>%
    as.matrix()

unname(data[1:4, 1:6])
sum(is.na(data)) / prod(dim(data))
hist(data)
```




In addition, I create a data frame that contains for each protein the information from which
species it came:

```{r}
species_assignment <- raw_data %>%
  dplyr::select(ProteinID = `Protein IDs`, FastaHeader = `Fasta headers`) %>%
  mutate(organism = str_match(FastaHeader,  "OS=([^\\s]+\\s[^\\s]+)\\s")[,2]) %>%
  mutate(contamination = str_starts(ProteinID, "CON__")) %>%
  mutate(organism_short = case_when(
    contamination ~ "Contamination",
    organism == "Homo sapiens" ~ "H. sapiens", 
    organism == "Escherichia coli" ~ "E. coli", 
    TRUE ~ "Unknown Organism")) %>%
  dplyr::select(ProteinID, organism_short)

table(species_assignment$organism_short)

species_assignment
```

I make a `SummarizedExperiment` with the data matrix and the species information.

```{r}
data_se <- SummarizedExperiment(data, 
                  rowData = column_to_rownames(species_assignment,
                                 "ProteinID")[rownames(data), ,drop=FALSE],
                  colData = tibble(condition = str_sub(colnames(data), 1, 1)))
data_se
```


I normalize the data so that the human proteins on average are not changed.

```{r}
data_norm_se <- proDA::median_normalization(data_se, 
                                spike_in_rows = rowData(data_se)$organism_short == "H. sapiens")
```



```{r}
data_for_plot <- assay(data_norm_se)
data_for_plot[is.na(data_for_plot)] <- 0
pheatmap::pheatmap(data_for_plot, show_rownames = FALSE, 
                   annotation_col = as.data.frame(colData(data_se)),
                   annotation_row = as.data.frame(rowData(data_norm_se)),
                   annotation_names_row = FALSE,
                   annotation_names_col = FALSE)
```










# Performance Comparison

Helper Method

```{r}
tidy_FDR <- function(data, predicted_FDR, known_class, ticks = ppoints(100)){
  
  # use tidy eval
  predicted_FDR <- rlang::enquo(predicted_FDR)
  known_class <- rlang::enquo(known_class)

  FDR_values <- rlang::eval_tidy(predicted_FDR, data)
  known_values <- rlang::eval_tidy(known_class, data)
  
  if(! is.logical(known_values)){
    stop("values in known_class must be of type logical.")
  }
  if(! is.numeric(FDR_values)){
    stop("values in known_class must be of type logical.")
  }
  
  if(any(FDR_values > 1, na.rm=TRUE) | any(FDR_values < 0, na.rm=TRUE)){
    stop("value in predicted_FDR must be between zero and one.")
  }
  
  map_dfr(ticks, function(thres){
    tab <- table(factor(FDR_values < thres, levels = c("TRUE", "FALSE")), 
                  factor(known_values, levels = c("TRUE", "FALSE")))
    tibble(DesiredFDR = thres, TP = tab[1,1], FP=tab[1,2], 
           ObservedFDR = ifelse(TP == 0 & FP == 0, 0, FP / (TP + FP)))
  })
  
}


```




```{r}
imp_methods <- list(
  list("zero"),
  list("QRILC"),
  list("knn", colmax = 0.95),
  list("MinDet"),
  list("MinProb")
)

```




Beautiful plot

```{r}
# color_mapping <- c(proDA = "#5a8c08", QPROT = "#fb8072", Perseus = "#386cb0",
#                    `knn-limma`="#5B127F", `QRILC-limma`="#D070FF", `MinDet-limma`="#B724FF",
#                    `MinProb-limma`="#68387F", `zero-limma`="#921DCC",
#                    DAPAR = "#a1791d", EBRCT = "#34eb8f", msempire = "black", MSqRob = "black")
color_mapping <- c(proDA = "#33A02C", 
                   `knn-limma`="#CAB2D6", `QRILC-limma`="#B294C7", `MinDet-limma`="#9A77B8", `MinProb-limma`="#825AA9", `zero-limma`="#6A3D9A",
                   DAPAR = "#1F78B4", 
                   Perseus = "#8AADBF",
                   QPROT = "#bfa419", EBRCT = "#B15928", 
                   msempire = "#FB9A99", MSqRob = "#E31A1C", Triqler = "#FF5E19")
background_painter <- data.frame(DesiredFDR=c(0, 0.1, 0.2), ObservedFDR=c(0, 0.1, 0.2))

plot(c(0, 1), c(0, 1), type="n")
rect(seq(0, 1-1/length(color_mapping), l=length(color_mapping)), 0, seq(1/length(color_mapping), 1, length=length(color_mapping)), 1, col=color_mapping)
text(x=seq(0, 1-1/length(color_mapping), l=length(color_mapping)) + 0.5/length(color_mapping), y=0.7, labels=color_mapping, srt=90)
text(x=seq(0, 1-1/length(color_mapping), l=length(color_mapping)) + 0.5/length(color_mapping), y=0.3, labels=names(color_mapping), srt=90)

```



```{r}

make_calib_and_perf_plot <- function(tp_fp_df){

  calib_plot <- tp_fp_df %>%
    ggplot(aes(x=DesiredFDR, y=ObservedFDR, group=method, color=method)) +
      geom_ribbon(data=background_painter, aes(ymax=ObservedFDR), ymin=0, color="white", fill="#91bfdb", alpha=0.1, group=99) +
      geom_ribbon(data=background_painter, aes(ymin=ObservedFDR), ymax=1, color="white", fill="#fc8d59", alpha=0.1, group=98) +
      annotate("text", x=0.085, y=0.03, hjust=0, label="conservative", size=5, alpha=0.5) +
      annotate("text", x=0.03, y=0.085, hjust=0, angle = 90, label="anti-conservative", size=5, alpha=0.5) +
      annotate("text", x=0.15, y=0.16, hjust=0, angle=45, label="optimal", alpha=0.5, size=5) +
      geom_segment(x = 0, y=0, xend=0.2, yend = 0.2, size=2, color = "grey") +
      geom_line() +
      geom_line(data=. %>% filter(method == "proDA"), size=1.5, color=color_mapping["proDA"]) +
      ggrepel::geom_label_repel(data=. %>% 
                     filter(DesiredFDR == max(DesiredFDR)),
                aes(label=nice_label, color= method),
                text.color = "black", segment.colour = "lightgrey", 
                anchor.side = "left", size=4,
                direction="y", hjust=1, xlim=c(0.215, NA)) +
      scale_color_manual(values= color_mapping,  guide="none") + 
      scale_x_continuous(breaks =  c(0, 0.05, 0.1, 0.15, 0.2), 
                         labels =  c("0", "0.05", "0.10", "0.15", "0.20"),
                         expand = expand_scale(add = 0.001, 0)) +
      scale_y_continuous(breaks =  c(0, 0.05, 0.1, 0.15, 0.2), 
                         labels =  c("0", "0.05", "0.10", "0.15", "0.20"),
                         expand = expand_scale(add = c(0.001, 0))) +
      lemon::coord_flex_fixed(xlim = c(0, 0.325), ylim=c(0,0.25), 
                              bottom = lemon::capped_horizontal("right", gap=0)) +
      xlab(paste0("Desired FDR", paste0(rep(" ", 32), collapse = ""))) + ylab("Actual FDR")
  
  max_tp <- max(tp_fp_df$TP) * 1.1
  perf_plot <- tp_fp_df %>%
    group_by(method) %>%
    mutate(anticons = ObservedFDR > DesiredFDR + 0.005) %>%
    mutate(linesection = cumsum(anticons != lag(anticons, default=anticons[1]))) %>%
    ggplot(aes(x=DesiredFDR, y=TP, group=paste0(method, "-", linesection), color=method)) +
      geom_line(data=. %>% filter(method != "proDA"), 
                aes(linetype = anticons)) +
      geom_line(data=. %>% filter(method == "proDA"), 
                aes(linetype = anticons),
                size=1.5, color=color_mapping["proDA"]) +
      ggrepel::geom_label_repel(data=. %>% 
                     filter(DesiredFDR == max(DesiredFDR)),
                aes(label=nice_label, color= method),
                text.color = "black", segment.colour = "lightgrey", 
                anchor.side = "left", size=4,
                direction="y", hjust=1, xlim=c(0.215, NA)) +
      scale_color_manual(values= color_mapping,  guide="none") +
      scale_linetype_manual(values=c(`FALSE` = "solid", `TRUE` = "39"), guide = "none") +
      scale_x_continuous(breaks =  c(0, 0.05, 0.1, 0.15, 0.2), 
                         labels =  c("0", "0.05", "0.10", "0.15", "0.20")) +
      ylim(0, max_tp) +
      lemon::coord_capped_cart(xlim = c(0, 0.3), gap = 0, 
                              expand = expand_scale(add = c(0.01, 0.1)),
                              bottom='right') +
      xlab(paste0("Desired FDR", paste0(rep(" ", 32), collapse = ""))) + ylab("True Positives") 
  list(calib_plot, perf_plot)
}

```



```{r}
run_tools <- function(methods = c("proDA", "DEP", "QPROT", "Perseus", "DAPAR", "EBRCT")){
  
  if("DEP" %in% methods && ! exists("imp_methods")){
    stop("imp_methods variable not yet initialized")
  }
  
  set.seed(1)

  data_norm <- assay(data_norm_se)
  experimental_design <- colData(data_norm_se)$condition 
  changed_df <- rowData(data_norm_se)[ ,"organism_short",drop=FALSE] %>%
                       as_tibble(rownames = "name") %>%
                       transmute(name, changed = organism_short ==  "E. coli")
  
  if("proDA" %in% methods){
    proDA_result <- run_proDA(data_norm,
                              experimental_design, verbose=TRUE)
    proDA_result_df <- as_tibble(proDA_result$result) %>%
      mutate(method = "proDA") %>% 
      inner_join(changed_df) %>%
      select(name, pval, adj_pval, diff, method, changed)
  }else{
    proDA_result_df <- NULL
  }
  
  if("EBRCT" %in% methods){
    ebrct_res <- run_ebrct(data_norm, experimental_design)

    ebrct_res_df <-  ebrct_res %>%
      mutate(method = "EBRCT") %>% 
      inner_join(changed_df) %>%
      select(name, pval, adj_pval, diff, method, changed)
  }else{
    ebrct_res_df <- NULL
  }
  
  if("DAPAR" %in% methods){
    dapar_result <- run_dapar(data_norm,
                              experimental_design)
    dapar_result_df <- as_tibble(dapar_result) %>%
      mutate(method = "DAPAR") %>% 
      inner_join(changed_df) %>%
      select(name, pval, adj_pval, diff, method, changed)
  }else{
    dapar_result_df <- NULL
  }

  if("DEP" %in% methods){
    dep_result_df <- map_dfr(imp_methods, function(imp_met){
      print(paste0("Do ", imp_met[[1]]))
      tmp <- do.call(run_dep, c(list(data_norm,
                                     experimental_design = experimental_design,
                     imputation_method = imp_met[[1]]), imp_met[-1]))
      tmp$method <- paste0(imp_met[[1]], "-limma")
      tmp <- inner_join(tmp, changed_df)
      tmp
    }) %>%
    select(name, pval, adj_pval, diff, method, changed)
  }else{
    dep_result_df <- NULL
  }
  
  if("QPROT" %in% methods){
    qprot_result <- run_qprot(data_norm[, experimental_design == "H"],
                              data_norm[, experimental_design == "L"])
    qprot_result_df <- as_tibble(qprot_result) %>%
      transmute(name=Protein, pval = pnorm(Zstatistic), adj_pval = fdr, diff=-LogFoldChange) %>%
      mutate(pval = pmin(pval, 1-pval) * 2) %>%
      mutate(method = "QPROT") %>% 
      inner_join(changed_df) %>%
      select(name, pval, adj_pval, diff, method, changed)
  }else{
    qprot_result_df <- NULL
  }

  if("Perseus" %in% methods){
    perseus_result<- run_perseus(data_norm, tag = paste0("_proteome_benchmark"), 
                                 return_null_if_missing = TRUE,
                                 dataset_name = "spikein_benchmark")
    if(is.null(perseus_result)){
      perseus_result_df <- NULL
    }else{
      perseus_result_df <- as_tibble(perseus_result) %>%
        mutate(method = "Perseus") %>% 
        inner_join(changed_df) %>%
        select(name, pval, adj_pval, diff, method, changed) 
    }
  }else{
    perseus_result_df <- NULL
  }

  null_df <- data.frame(method = character(0),
                        name = character(0),
                        pval = numeric(0),
                        adj_pval = numeric(0),
                        diff = numeric(0),
                        changed = logical(0),
                        stringsAsFactors = FALSE)
                        
  res_df <- bind_rows(list(null_df, dep_result_df ,
    proDA_result_df,
    qprot_result_df ,
    perseus_result_df,
    dapar_result_df,
    ebrct_res_df))
  
  list(res_df = res_df)
}

run_performance_comparison <- function(methods = c("proDA", "DEP", "QPROT", "Perseus", "DAPAR", "EBRCT")){
  run_tools(methods)$res_df %>%
    filter(diff > 0) %>%
    group_by(method) %>%
    do({tidy_FDR(., adj_pval, changed, ticks = ppoints(501) * 0.2)}) %>%
    mutate(nice_label = case_when(
      method == "zero-limma" ~ "DEP: Zero",
      method == "knn-limma" ~ "DEP: KNN",
      str_detect(method, "limma") ~ paste0("DEP: ", str_remove(method, "-limma")),
      TRUE ~ method
    ))
}
```




```{r}
tp_df_benchmark <- run_performance_comparison(methods =  c("proDA", "DEP", "QPROT", "Perseus", "DAPAR", "EBRCT")) 
```


```{r}
msqrob_res <- run_msqrob_on_cox_benchmark()
tp_df_benchmark <- msqrob_res %>%
  mutate(changed= organism_short == "E. coli") %>%
  filter(diff > 0) %>%
  do({tidy_FDR(., adj_pval, changed, ticks = ppoints(501) * 0.2)}) %>%
  mutate(method = "MSqRob",
         nice_label = "MSqRob")  %>%
  bind_rows(tp_df_benchmark)
```



```{r}
msempire_res <- run_msempire_on_cox_benchmark()
tp_df_benchmark <- msempire_res %>%
  mutate(changed= organism_short == "E. coli") %>%
  filter(diff > 0) %>%
  do({tidy_FDR(., adj_pval, changed, ticks = ppoints(501) * 0.2)}) %>%
  mutate(method = "msempire",
         nice_label = "MS-Empire") %>%
  bind_rows(tp_df_benchmark)


```


```{r}
triqler_res <- parse_triqler_results_for_cox_benchmark()
tp_df_benchmark <- triqler_res %>%
  mutate(changed= organism_short == "E. coli") %>%
  filter(diff > 0) %>%
  do({tidy_FDR(., adj_pval, changed, ticks = ppoints(501) * 0.2)}) %>%
  mutate(method = "Triqler",
         nice_label = "Triqler")  %>%
  bind_rows(tp_df_benchmark)

```




```{r}
perf_plot <- make_calib_and_perf_plot(tp_df_benchmark)
plot_grid(plotlist = perf_plot, labels=c("A", "B"), nrow=1)
ggsave("plots/calib_perf_plot_benchmark.pdf", width=12, height=4)
```





```{r}
tp_df_benchmark %>%
  group_by(method) %>%
  filter(seq_len(n()) == which.min(abs(DesiredFDR - 0.2))) %>%
  arrange(- ObservedFDR)
```





